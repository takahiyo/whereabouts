# CSS分割・改修ガイド

本ドキュメントは、CSSの分割・整理・改修において**デザイン崩れや挙動変更を防ぐ**ための規則を定める。

---

## 基本思想

- CSSは**宣言順・構造・状態**に依存する
- 見た目が同じでも、CSSの評価条件が変わると挙動は破壊される
- CSS分割は「設計作業」ではなく、**設計に基づく物理作業**である

> **参照元を調べずにCSSを分割してはならない**

---

## 参照元の種類

CSSの「参照元」は単にHTML内のclass/idではない。以下のレイヤーに分散している。

| 区分 | 内容 | 代表例 |
|------|------|--------|
| HTML構造 | 静的DOMの構造・順序 | 親子・兄弟・隣接関係 |
| JS（状態） | class/attributeの付与・除去 | `.visible`, `body.xxx` |
| JS（変数） | CSS変数の操作 | `style.setProperty('--var')` |
| JS（生成） | DOMの動的生成 | `innerHTML`, `createElement` |
| 外部DOM | iframe・外部スクリプト | OAuth、埋め込み |
| CSS内部 | 上書き・モード・メディア | theme, state, @media |

**CSSは単独では完結しない**ことを常に前提とする。

---

## 参照元情報の付記形式

各スタイルブロックの直前に、参照元情報をコメントとして付記する。

```css
/* =====================================
[REF]
- HTML: 親子/兄弟/順序依存の有無
- JS: class操作/変数操作/DOM生成
- STATE: 状態クラス・モード依存
- LAYER: z-index・重なり制御
- SPLIT: SAFE | GROUP | LAST
===================================== */
.example-class {
  /* ... */
}
```

### 各項目の意味

| 項目 | 内容 |
|------|------|
| HTML | 静的要素か、DOM構造への依存有無 |
| JS | classList操作、CSS変数操作、動的生成への依存 |
| STATE | 状態クラス（表示/非表示/モード）、body直下クラスの影響 |
| LAYER | z-index管理、overlay/modal/menuとの前後関係 |
| SPLIT | `SAFE`=単独ファイル化可、`GROUP`=同一ファイル必須、`LAST`=後段評価必須 |

---

## 絶対禁止事項

以下を行った場合、**作業失敗とみなす**。

### 内容変更の禁止

- セレクタの変更・整理・統合
- プロパティ/値の変更（数値・単位・色含む）
- CSS変数の追加・削除・改名・集約
- 未使用判断による削除
- `@keyframes` の整理・統合
- `!important` の追加・削除
- 自動フォーマットの適用

### 順序変更の禁止

- CSSは**元の出現順を100%保持**すること
- 分割後も**同じ順序で評価される**ことを保証すること
- 状態上書き・モードCSSは必ず後段に配置すること

---

## 分割作業のフェーズ

### フェーズ1: 参照元調査（編集禁止）

- CSS編集禁止
- 参照元コメント付記のみ

```bash
# class操作の検索
grep -rn "classList" src/ assets/

# CSS変数操作の検索
grep -rn "setProperty\|getPropertyValue" src/ assets/

# 動的DOM生成の検索
grep -rn "innerHTML\|createElement" src/ assets/
```

### フェーズ2: 分割計画

- SPLIT区分に基づきファイル構成を決定
- 読み込み順を確定

```markdown
## 分割計画
1. base.css（リセット、基本要素）
2. layout.css（レイアウト構造）
3. components.css（UIコンポーネント）
4. state.css（状態上書き）← 必ず最後
```

### フェーズ3: 物理分割

- **内容変更なし**
- **順序維持**
- コピー&ペースト作業のみ

### フェーズ4: 検証

- 状態遷移の確認
- 重なり（z-index）の確認
- モード切替（テーマ等）の確認
- レスポンシブの確認

---

## 分割時のチェックリスト

### 作業前

- [ ] 参照元調査を完了したか
- [ ] 全スタイルブロックに[REF]コメントを付記したか
- [ ] 分割計画を文書化したか
- [ ] 読み込み順序を確定したか

### 作業中

- [ ] セレクタを変更していないか
- [ ] プロパティ値を変更していないか
- [ ] 出現順序を維持しているか
- [ ] 「ついでに」の最適化をしていないか

### 作業後

- [ ] 全状態でデザインが維持されているか
- [ ] z-indexの重なりが正しいか
- [ ] テーマ切替が動作するか
- [ ] レスポンシブが維持されているか

---

## 危険なパターンと対策

### モード・状態の上書きCSS

```css
/* 危険: 順序を変えると上書きが効かなくなる */
.button { background: blue; }
.button.active { background: red; }  /* 必ず後に配置 */
```

**対策**: SPLIT=LAST を付記し、分割時も順序を維持

### z-indexの階層

```css
/* 危険: z-indexは相対的な順序が重要 */
.header { z-index: 100; }
.modal { z-index: 200; }
.tooltip { z-index: 300; }
```

**対策**: LAYER情報を[REF]に明記し、関連するz-indexを同一ファイルに維持

### メディアクエリの位置

```css
/* 危険: メディアクエリは対象ルールより後に配置が必要 */
.container { width: 100%; }
@media (min-width: 768px) {
  .container { width: 750px; }
}
```

**対策**: メディアクエリを分離する場合、読み込み順序を必ず後にする

---

## AIへの注意事項

- CSSが巨大であるほど、参照元調査の価値は高い
- **「理由」が明示されていないとAIは最適化を行う傾向がある**
- 本ガイドは**AIの暴走を防ぐための設計書**として機能する

分割・整理で失敗する原因の大半は：

> 「どこで、なぜ、そのCSSが効いているか」を把握せずに触ること

参照元調査と条件定義を先に行えば、分割は安全な事務作業になる。

---

## 関連ドキュメント

- [CORE_PRINCIPLES.md](./CORE_PRINCIPLES.md) - 基本原則
- [REFACTOR_GUIDE.md](./REFACTOR_GUIDE.md) - 分割・リファクタリング全般
- [COMMENT_GUIDE.md](./COMMENT_GUIDE.md) - コメント規約
