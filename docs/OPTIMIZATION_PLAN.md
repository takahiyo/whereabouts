# スリム化・最適化の段階的計画（Firestore主軸 + Workers/RealtimeDBフォールバック）

## 目的
- Firebase 無料枠内で運用するため、不要通信・重複通信の削減を最優先にする。
- 保守性を高めるため、設定・スタイル・データ取得の責務を明確化する。
- 旧GAS由来の資産は明示的に棚卸しし、削除または退役の判断を行う。

## 前提（構成）
- Plan A: Firestore SDK リアルタイムリスナーを主軸とする。
- Plan B: Cloudflare Workers 経由 + Firebase Realtime Database のフォールバックを継続。

---

## 段階的スリム化計画（優先度順）

### フェーズ 1: 通信削減と可観測性の確保（最優先）
**狙い:** 無料枠を圧迫する通信を可視化し、実測で「どこが無駄か」を特定する。

1. **通信ログの粒度統一**
   - 取得・書き込みのトリガーをログ出力（Plan A / Plan B で共通フォーマット）。
   - 目的: 実際に発火している通信（読み取り回数/頻度）を把握し、優先削減対象を決定。

2. **Firestore リスナー接続の最小化**
   - 画面非表示/タブ離脱時にリスナー停止。
   - 同一データへの重複リスナーを削除（通知/ツールなどのセクション単位で確認）。
   - 目的: 無駄な read / snapshot 更新の削減。

3. **Workers 経由の再送頻度調整**
   - Plan B にフォールバックした場合の再試行間隔を指数バックオフに統一。
   - 目的: 接続不調時の過剰リクエスト抑制。

---

### フェーズ 2: Firestore 使用量の抑制
**狙い:** Firestore の read/write/egress を恒常的に抑える。

1. **ドキュメント設計の見直し**
   - 更新頻度の高いフィールドを分割し、1回の更新で全体を書き換えない構成へ。
   - 目的: 不必要なドキュメント全体書き換えを抑制。

2. **クエリ頻度の抑制**
   - 初回読み込み後は差分反映を重視。
   - 更新頻度の低い設定値はキャッシュ（期限付き）に寄せる。

3. **書き込み回数の抑制**
   - 連続操作をまとめて書き込み（バッチ / デバウンス）。
   - 目的: ユーザー操作のたびに write を発生させない。

---

### フェーズ 3: 保守性向上（スタイル定義・設定の一元化）
**狙い:** 変更時の影響範囲を最小化し、更新漏れを防ぐ。

1. **スタイル定義の一元化**
   - 色・余白・フォントなどを CSS 変数に集約。
   - スタイル定義の重複箇所を棚卸しし、単一ソース化。

2. **設定・コンフィグの集約**
   - Firestore 側の config ドキュメント、Cloudflare Workers 側の設定の重複を洗い出す。
   - どの値が「唯一の正」のソースかを明文化。

---

### フェーズ 4: 旧GAS由来ファイルの整理
**狙い:** 退役済み資産を削除し、誤参照と保守コストを排除。

1. **棚卸し**
   - GAS ファイル・ドキュメントを一覧化。
   - 依存関係（参照箇所・実行導線）を洗い出す。

2. **削除またはアーカイブ**
   - 明確に不要なものは削除。
   - 将来的に参照する可能性があるものは `legacy/` などに隔離し README に理由を記載。

---

## 不要ファイル検出の方針（例）
- 参照されていない JS / CSS / 画像の洗い出し（import 追跡・ビルド対象確認）。
- ドキュメントの重複（説明が古い/同じ内容）を統合。
- GAS 由来のスクリプト・手順書の退役判断。

---

## レビュー可能なチェックリスト（完了判定）

### 通信削減
- [ ] Firestore リスナーの重複が無いことをログで確認
- [ ] 画面非表示時に listener が解除される
- [ ] Plan B の再送間隔が指数バックオフになっている

### Firestore 使用量
- [ ] 更新頻度の高い値が分離されている
- [ ] 低頻度の設定はキャッシュされている
- [ ] 連続操作がバッチ/デバウンスでまとめられている

### 保守性
- [ ] CSS 変数への集約が完了している
- [ ] 設定の「唯一の正」ソースが明文化されている

### 旧GAS整理
- [x] GAS 由来ファイルの棚卸し一覧が存在する
- [x] 削除/アーカイブ判断が記録されている
