<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表</title>
<style>
  :root{
    --line:#d9d9d9; --head:#f1ece6; --bg:#fafafa;
    --present:#e8f6e8; --away:#fff3e6; --remote:#e8f0ff; --off:#f7e8ee; --home:#ffe8f0;
  }
  body{font-family:"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff;margin:16px}
  header{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  header h1{font-size:14px;font-weight:600;color:#4a5568;margin:0;padding:.35rem .9rem;background:#dff1ff;border-radius:999px}
  header .tools{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  button{border:1px solid var(--line);background:#fff;padding:.45rem .7rem;border-radius:8px;cursor:pointer}
  button:hover{background:#f7f7f7}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* レイアウト */
  .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:18px}
  .panel{border:1px solid var(--line);border-radius:6px;background:var(--bg);padding:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--head);font-weight:700}
  th,td{border:1px solid var(--line);padding:6px;font-size:14px}
  th{text-align:left}

  /* 列幅 */
  td.name{background:#fff;width:18%}
  td.status{width:35%;min-width:10.5em}
  td.time{width:12%;min-width:6.2em}
  td.note{width:35%}

  /* コントロール */
  select,input[type="text"]{
    width:100%;box-sizing:border-box;padding:.3rem .35rem;border:1px solid var(--line);
    border-radius:4px;background:#fff;font-size:14px;appearance:auto;-webkit-appearance:auto
  }
  td.time select{width:100%}

  /* 備考：候補 + 自由入力（先頭は空） */
  .note .wrap{display:flex;gap:6px;align-items:center}
  .note .quick{flex:0 0 7.5em}
  .note .free{flex:1 1 auto}

  /* ステータス色 */
  tr[data-status="在席"]{background:var(--present)}
  tr[data-status="外出"]{background:var(--away)}
  tr[data-status="休み"],tr[data-status="健康診断"],tr[data-status="コアドック"]{background:var(--off)}
  tr[data-status="帰宅"]{background:var(--home)}
  tr[data-status="在宅勤務"]{background:var(--remote)}
  tr[data-status="出張"],tr[data-status="研修"]{background:var(--away)}

  /* トースト */
  .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:8px 12px;border-radius:4px;font-size:12px;opacity:0;transition:.25s;z-index:9999}
  .toast.show{opacity:1}

  /* スマホ最適化 */
  @media(max-width:768px){
    .board{grid-template-columns:1fr;gap:12px}
    header{flex-direction:column;gap:12px}
    header .tools{margin-left:0;justify-content:center}
    body{margin:8px}
    button,select,input[type="text"]{font-size:16px}
    th,td{padding:8px}
  }

<script>
/* ========= 同期設定（トークン必須JSONP/GAS） ========= */
const REMOTE_ENDPOINT = "https://script.google.com/macros/s/AKfycbxNpuP-Yb8C39CBkh5Wcb4mYHNSf7XsDfzG_QN7BcdZL184R3dnsD06YI1O_ks0uccb/exec";
const REMOTE_KEY      = "presence-board-default";
const REMOTE_TOKEN    = "Eqxeh4Ygij6zAy5ceEVHZFSzHm7QcMYZa9WgtLMj";
const REMOTE_POLL_MS  = 8000;

/* ========= データ ========= */
const STATUSES = ["在席","外出","休み","帰宅","在宅勤務","出張","研修","健康診断","コアドック"];
const groups = [
  ["村田","今泉","北村","大野","長谷川","横内"],
  ["佐藤","井上","折原","金村","水野","坪井"],
  ["清水","加藤","石垣","橋本","末永","田中光","大石","井山"],
  ["飯島","能登","松浦","永峯","清","長森","山本"],
  ["伊藤隆","小森","三浦","中村純","朝井","稲葉"],
  ["吉田","阿部","伊藤裕","中村清","平良","若山","竹森","平八重"],
  ["鈴木","中村亮","江場","三島","吉田","小川","伊藤尊"]
];
const storeKey = "presence-board-v2";

/* ========= レンダリング ========= */
const board = document.getElementById('board');
const toastEl = document.getElementById('toast');

function timeOptions(){
  const opts=['<option value=""></option>'];
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=30){
      const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      opts.push(`<option value="${t}">${t}</option>`);
    }
  }
  return opts.join('');
}

function rowHtml(gIndex,rIndex,name){
  const key=`${gIndex}-${rIndex}`;
  return `
    <tr id="row-${key}" data-key="${key}" data-status="在席">
      <td class="name">${name}</td>
      <td class="status">
        <label class="sr-only" for="status-${key}">ステータス</label>
        <select id="status-${key}" name="status">
          ${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join("")}
        </select>
      </td>
      <td class="time">
        <label class="sr-only" for="time-${key}">戻り時間</label>
        <select id="time-${key}" name="time">${timeOptions()}</select>
      </td>
      <td class="note">
        <div class="wrap">
          <select id="noteq-${key}" class="quick" aria-label="備考（候補）">
            <option value=""></option>
            <option value="直出">直出</option>
            <option value="直帰">直帰</option>
            <option value="直出/直帰">直出/直帰</option>
          </select>
          <input id="note-${key}" class="free" name="note" type="text" placeholder="備考" />
        </div>
      </td>
    </tr>`;
}

function panelHtml(gIndex,names){
  return `
    <section class="panel">
      <table aria-label="在席表">
        <thead><tr><th>氏名</th><th>ステータス</th><th>戻り時間</th><th>備考</th></tr></thead>
        <tbody>${names.map((n,i)=>rowHtml(gIndex,i,n)).join("")}</tbody>
      </table>
    </section>`;
}

function render(){
  board.innerHTML = groups.map((g,i)=>panelHtml(i,g)).join('');
  wireEvents();
  loadLocal();
  recolor();
}

/* ========= 状態入出力 ========= */
function getState(){
  const data={};
  board.querySelectorAll("tbody tr").forEach(tr=>{
    const k=tr.dataset.key;
    data[k]={
      status: tr.querySelector('select[name="status"]').value,
      time:   tr.querySelector('select[name="time"]').value,
      note:   tr.querySelector('.free').value
    };
  });
  return data;
}

/* 送信用に省データ化（在席 & 空欄は送らない） */
function getStateForPush(){
  const full = getState();
  const slim = {};
  for(const [k,v] of Object.entries(full)){
    if(v.status!=="在席" || v.time || (v.note && v.note.trim()!=="")){
      slim[k]=v;
    }
  }
  return slim;
}

function applyState(data){
  if(!data) return;
  Object.entries(data).forEach(([k,v])=>{
    const s=document.getElementById(`status-${k}`);
    const t=document.getElementById(`time-${k}`);
    const n=document.getElementById(`note-${k}`);
    const q=document.getElementById(`noteq-${k}`);
    if(s && v.status && STATUSES.includes(v.status)) s.value=v.status;
    if(t) t.value = v.time || "";
    if(n) n.value = v.note || "";
    if(q){
      const values=[...q.options].map(o=>o.value);
      q.value = values.includes(n.value) ? n.value : "";
    }
  });
  recolor();
}

function saveLocal(){
  try{
    localStorage.setItem(storeKey, JSON.stringify(getState()));
    toast('保存しました');
  }catch(_){}
}

function loadLocal(){
  try{
    const raw = localStorage.getItem(storeKey); if(!raw) return;
    applyState(JSON.parse(raw));
  }catch(_){}
}

/* ========= 操作イベント ========= */
function wireEvents(){
  board.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change", ()=>{ saveLocal(); pushRemoteThrottled(); });
  });
  board.querySelectorAll(".quick").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const key = sel.id.replace("noteq-","");
      const input = document.getElementById(`note-${key}`);
      input.value = sel.value; saveLocal(); pushRemoteThrottled();
    });
  });
  board.querySelectorAll(".free").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const key = inp.id.replace("note-","");
      const sel = document.getElementById(`noteq-${key}`);
      const values=[...sel.options].map(o=>o.value);
      sel.value = values.includes(inp.value) ? inp.value : "";
    });
  });

  document.getElementById('btnPrint').addEventListener('click', ()=>window.print());
}

/* ========= 見た目 ========= */
function recolor(){
  board.querySelectorAll("tbody tr").forEach(tr=>{
    tr.dataset.status = tr.querySelector('select[name="status"]').value;
  });
}

function toast(msg){
  toastEl.textContent=msg; toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),1000);
}

/* ========= JSONPユーティリティ ========= */
function jsonp(url){
  return new Promise((resolve)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{
      resolve(data);
      try{ delete window[cb]; }catch(_){}
      if(s.remove){ s.remove(); } else if(s.parentNode){ s.parentNode.removeChild(s); }
    };
    const s=document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror=()=>{
      resolve(null);
      try{ delete window[cb]; }catch(_){}
      if(s.remove){ s.remove(); } else if(s.parentNode){ s.parentNode.removeChild(s); }
    };
    document.body.appendChild(s);
  });
}

/* ========= 同期（トークン必須） ========= */
let lastPushed=0;
function pushRemoteThrottled(){ const now=Date.now(); if(now-lastPushed>1200){ lastPushed=now; pushRemote(); } }

async function pullRemote(){
  if(!REMOTE_ENDPOINT || !REMOTE_TOKEN){ toast('同期先が未設定です'); return; }
  const url = `${REMOTE_ENDPOINT}?action=get&key=${encodeURIComponent(REMOTE_KEY)}&token=${encodeURIComponent(REMOTE_TOKEN)}`;
  const remote = await jsonp(url); // {updated:..., data:{...}} or {error:"unauthorized"}
  if(!remote) return;
  if(remote.error){ toast('同期エラー: 認証失敗'); return; }

  // 受信データを適用。未送信（省略）行は既定値（在席/空）としてそのまま表示
  if(remote.data){
    applyState(remote.data);
    try{ localStorage.setItem(storeKey, JSON.stringify(Object.assign({}, getState(), remote.data))); }catch(_){}
  }
}

async function pushRemote(){
  if(!REMOTE_ENDPOINT || !REMOTE_TOKEN) return;
  const payload = encodeURIComponent(JSON.stringify({updated:Date.now(), data:getStateForPush()}));
  const url = `${REMOTE_ENDPOINT}?action=set&key=${encodeURIComponent(REMOTE_KEY)}&data=${payload}&token=${encodeURIComponent(REMOTE_TOKEN)}`;
  const res = await jsonp(url);
  if(res && res.error){ toast('同期エラー: 認証失敗'); }
}

function startRemoteSync(){
  if(!REMOTE_ENDPOINT || !REMOTE_TOKEN){ toast('同期先が未設定です'); }
  // 初回＆フォーカス復帰で必ず取得（初期白紙防止）
  pullRemote();
  setInterval(pullRemote, REMOTE_POLL_MS);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) pullRemote(); });
  window.addEventListener('focus', pullRemote);

  // 同一端末の別タブからの更新を即時反映
  window.addEventListener('storage', (e)=>{
    if(e.key===storeKey && e.newValue){
      try{ applyState(JSON.parse(e.newValue)); }catch(_){}
    }
  });
}

/* ========= 起動 ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  render();
  startRemoteSync();
});

/* デバッグ：JSエラーを画面表示 */
window.addEventListener('error', e=>{
  toastEl.style.background='#c53030';
  toastEl.textContent='エラー: '+e.message; toastEl.classList.add('show');
});
</script>
</body>
</html>

