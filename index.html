<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表</title>
<style>
  :root{
    --line:#d9d9d9; --head:#f1ece6; --bg:#fafafa;
    --present:#e8f6e8; --away:#fff3e6; --remote:#e8f0ff; --off:#f7e8ee; --home:#ffe8f0;
    /* 盤面レイアウト */
    --board-col-min: 360px;     /* 各表の最小幅 */
    --board-gap: 18px;          /* 表間の間隔 */
    --board-max-cols: 3;        /* PC時の最大列数 */
  }

  body{font-family:"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff;margin:16px}
  header{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  header h1{font-size:14px;font-weight:600;color:#4a5568;margin:0;padding:.35rem .9rem;background:#dff1ff;border-radius:999px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* 盤面（最大3列に制限して中央寄せ） */
  .board{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(var(--board-col-min), 1fr));
    gap: var(--board-gap);
    max-width: calc(var(--board-max-cols) * var(--board-col-min) + (var(--board-max-cols) - 1) * var(--board-gap));
    margin: 0 auto;
  }
  .panel{border:1px solid var(--line);border-radius:6px;background:var(--bg);padding:8px}
  .panel .title{font-weight:700;color:#6b7280;background:#f7f7f7;border:1px solid var(--line);
                border-radius:4px;padding:6px 8px;margin:0 0 6px 0; min-height:1.8em}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--head);font-weight:700}
  th,td{border:1px solid var(--line);padding:6px;font-size:14px}
  th{text-align:left}

  /* 列幅（合計100%：14 + 7 + 35 + 8 + 36） */
  td.name   { background:#fff; width:14% }
  td.ext    { width: 7% }
  td.status { width:35%; min-width:13em }
  td.time   { width: 8%;  min-width:5.2em }
  td.note   { width:36% }

  /* コントロール */
  select,input[type="text"]{
    width:100%;box-sizing:border-box;padding:.3rem .35rem;border:1px solid var(--line);
    border-radius:4px;background:#fff;font-size:14px;appearance:auto;-webkit-appearance:auto
  }
  /* 時刻は数字を中央寄せ＆等幅 */
  td.time select{
    text-align-last:center;
    font-variant-numeric:tabular-nums;
  }
  /* ステータス：矢印分の余白を最小化（文字が見えるように） */
  td.status select{ padding-right:1.2em; }

  /* 備考：候補 + 自由入力（先頭は空） */
  .note .wrap{display:flex;gap:6px;align-items:center}
  .note .quick{flex:0 0 7.5em}
  .note .free{flex:1 1 auto}

  /* ステータス色 */
  tr[data-status="在席"]{background:var(--present)}
  tr[data-status="外出"]{background:var(--away)}
  tr[data-status="休み"],tr[data-status="健康診断"],tr[data-status="コアドック"]{background:var(--off)}
  tr[data-status="帰宅"]{background:var(--home)}
  tr[data-status="在宅勤務"]{background:var(--remote)}
  tr[data-status="出張"],tr[data-status="研修"]{background:var(--away)}

  /* トースト */
  .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:8px 12px;border-radius:4px;font-size:12px;opacity:0;transition:.25s;z-index:9999}
  .toast.show{opacity:1}

  /* ログインオーバーレイ（ログイン前は表を描画しない） */
  .login{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000}
  .login .card{background:#fff;border-radius:8px;padding:20px;min-width:300px;max-width:90vw;text-align:center}
  .login .card h2{margin:.2rem 0 1rem}
  .login .card input{margin:.4rem 0}

  /* スマホ：1列表示 */
  @media(max-width:768px){
    .board{ grid-template-columns: 1fr; gap:12px; max-width:none }
    header{ flex-direction:column; gap:12px }
    body{ margin:8px }
    select,input[type="text"]{ font-size:16px } /* iOSズーム防止 */
    th,td{ padding:8px }
    td.status{ min-width:12.5em }
  }

  /* 印刷 */
  @media print{
    header,.toast,.login{display:none}
    body{margin:0}
    .board{gap:10px; max-width:none}
    th,td{font-size:12px;padding:4px}
  }

  /* “謎の楕円”対策（拡張が挿入するハンドルを隠す） */
  .board [draggable], .board [role="separator"]{ display:none !important; }
</style>
</head>
<body>
  <header><h1>在席確認表（同期対応）</h1></header>

  <!-- ログイン -->
  <div id="login" class="login" style="display:none">
    <div class="card">
      <h2>在席確認表</h2>
      <p>パスワードを入力してください</p>
      <input type="password" id="pw" placeholder="Password" />
      <button id="btnLogin" onclick="window.__doLogin && window.__doLogin()">ログイン</button>
      <div id="loginMsg" style="color:#c53030;margin-top:8px"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <!-- ★ ログイン＆設定取得後に描画／表示 -->
  <div id="board" class="board" style="display:none"></div>

<script>
/* ====== 設定 ====== */
const REMOTE_ENDPOINT = '<<GAS_WEB_APP_URL>>';   // 例: https://script.google.com/macros/s/.../exec
const DATA_KEY        = 'presence-board-default';
const CONFIG_KEY      = 'presence-config';
const POLL_MS         = 30000;    // 30秒
const SESSION_KEY     = 'presence-session-token';

/* ====== マスタ ====== */
const STATUSES = ["在席","外出","休み","帰宅","在宅勤務","出張","研修","健康診断","コアドック"];
const STATUS_CLEAR = new Set(["在席","休み","帰宅","在宅勤務"]); // 選択時に time/note を空に

/* ====== 要素 ====== */
const boardEl = document.getElementById('board');
const toastEl = document.getElementById('toast');
const loginEl = document.getElementById('login');
const pwInput  = document.getElementById('pw');
const loginMsg = document.getElementById('loginMsg');

/* ====== ユーティリティ ====== */
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1000); }
function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* JSONP（タイムアウト・キャッシュバスター付き） */
function jsonp(url, timeout=12000){
  return new Promise((resolve)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    let done=false;
    const cleanup=(s)=>{ try{ delete window[cb]; }catch(_){} if(s){ if(s.remove){s.remove();} else if(s.parentNode){s.parentNode.removeChild(s);} } };
    const timer=setTimeout(()=>{ if(!done){ done=true; cleanup(script); resolve(null); } }, timeout);
    window[cb]=(data)=>{ if(done) return; done=true; clearTimeout(timer); cleanup(script); resolve(data); };
    const script=document.createElement('script');
    script.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    script.onerror=()=>{ if(!done){ done=true; clearTimeout(timer); cleanup(script); resolve(null); } };
    document.body.appendChild(script);
  });
}

/* ====== ログイン ====== */
let SESSION_TOKEN = '';
function showLogin(msg=""){ loginEl.style.display='flex'; loginMsg.textContent = msg || ""; setTimeout(()=>pwInput?.focus(),50); }
function hideLogin(){ loginEl.style.display='none'; loginMsg.textContent=""; pwInput.value=""; }

async function login(pw){
  loginMsg.textContent = "認証中…";
  const res = await jsonp(`${REMOTE_ENDPOINT}?action=login&password=${encodeURIComponent(pw)}`);
  if(res && res.token){
    SESSION_TOKEN = res.token;
    sessionStorage.setItem(SESSION_KEY, SESSION_TOKEN);
    hideLogin();
    toast('ログインしました');
    if(res.exp) scheduleRenew(res.exp);
    await bootAfterLogin(); // 設定取得→描画→同期開始
  }else{
    loginMsg.textContent = "パスワードが違います";
  }
}
function scheduleRenew(ttlMs){
  clearTimeout(scheduleRenew._t);
  const ms = Math.max(60000, Math.floor(ttlMs*0.8));
  scheduleRenew._t = setTimeout(async ()=>{
    const r = await jsonp(`${REMOTE_ENDPOINT}?action=renew&token=${encodeURIComponent(SESSION_TOKEN)}`);
    if(!(r && r.ok)){ sessionStorage.removeItem(SESSION_KEY); SESSION_TOKEN=""; showLogin("セッションが切れました。再ログインしてください。"); }
    else scheduleRenew(r.exp || 3600000);
  }, ms);
}
function requireToken(){ SESSION_TOKEN = sessionStorage.getItem(SESSION_KEY) || ""; return !!SESSION_TOKEN; }

/* ====== 設定（グループ＋名簿＋内線） ====== */
let GROUPS = [];   // [{title:'', members:[{name, ext?}, ...]}, ...]
async function loadConfig(){
  const res = await jsonp(`${REMOTE_ENDPOINT}?action=getConfig&key=${encodeURIComponent(CONFIG_KEY)}&token=${encodeURIComponent(SESSION_TOKEN)}`);
  if(!res){ throw new Error('設定取得エラー'); }
  if(Array.isArray(res)){
    GROUPS = res.map(g=>({ title:'', members: g.map(n=>({name:n})) }));
  }else if(res && Array.isArray(res.groups)){
    GROUPS = res.groups.map(g=>({
      title: typeof g.title==='string' ? g.title : '',
      members: Array.isArray(g.members) ? g.members.map(m=>({ name:m.name, ext: m.ext||'' })) : []
    }));
  }else{
    GROUPS = [];
  }
}

/* ====== 盤面生成 ====== */
function timeOptions(){
  const opts=['<option value=""></option>'];
  for(let h=0;h<24;h++){ for(let m=0;m<60;m+=30){
    const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    opts.push(`<option value="${t}">${t}</option>`);
  }} return opts.join('');
}
function rowHtml(gIndex, mIndex, member){
  const key=`${gIndex}-${mIndex}`;
  const nm = escapeHtml(member.name||'');
  const ex = escapeHtml(member.ext||'');
  return `
    <tr id="row-${key}" data-key="${key}" data-status="在席">
      <td class="name">${nm}</td>
      <td class="ext">
        <label class="sr-only" for="ext-${key}">内線</label>
        <input id="ext-${key}" name="ext" type="text" inputmode="numeric" pattern="^[0-9]{0,4}$" maxlength="4" value="${ex}" placeholder="内線" />
      </td>
      <td class="status">
        <label class="sr-only" for="status-${key}">ステータス</label>
        <select id="status-${key}" name="status">
          ${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join("")}
        </select>
      </td>
      <td class="time">
        <label class="sr-only" for="time-${key}">戻り時間</label>
        <select id="time-${key}" name="time">${timeOptions()}</select>
      </td>
      <td class="note">
        <div class="wrap">
          <select id="noteq-${key}" class="quick" aria-label="備考（候補）">
            <option value=""></option><option value="直出">直出</option>
            <option value="直帰">直帰</option><option value="直出/直帰">直出/直帰</option>
          </select>
          <input id="note-${key}" class="free" name="note" type="text" placeholder="備考" />
        </div>
      </td>
    </tr>`;
}
function panelHtml(gIndex, group){
  const title = escapeHtml(group.title||'');
  const rows  = (group.members||[]).map((m,i)=>rowHtml(gIndex,i,m)).join('');
  return `
    <section class="panel">
      <div class="title">${title}</div>
      <table aria-label="在席表">
        <thead><tr><th>氏名</th><th>内線</th><th>ステータス</th><th>戻り時間</th><th>備考</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </section>`;
}
function render(){
  boardEl.innerHTML = GROUPS.map((g,i)=>panelHtml(i,g)).join('');
  boardEl.style.display = ''; // 初表示
  wireEvents();
  loadLocal();
  recolor();
}

/* ====== 状態 入出力 ====== */
const storeKey = 'presence-board-v2';
function getState(){
  const data={};
  boardEl.querySelectorAll('tbody tr').forEach(tr=>{
    const k = tr.dataset.key;
    data[k] = {
      status: tr.querySelector('select[name="status"]').value,
      time:   tr.querySelector('select[name="time"]').value,
      note:   tr.querySelector('.free').value,
      ext:    tr.querySelector('input[name="ext"]').value
    };
  });
  return data;
}
function getStateForPush(){
  const full=getState(), slim={};
  for(const [k,v] of Object.entries(full)){
    const def = (v.status==="在席" && !v.time && !v.note && !v.ext);
    if(!def) slim[k]=v;
  }
  return slim;
}
function applyState(map){
  if(!map) return;
  Object.entries(map).forEach(([k,v])=>{
    const s=document.getElementById(`status-${k}`);
    const t=document.getElementById(`time-${k}`);
    const n=document.getElementById(`note-${k}`);
    const q=document.getElementById(`noteq-${k}`);
    const e=document.getElementById(`ext-${k}`);
    if(s && v.status && STATUSES.includes(v.status)) s.value=v.status;
    if(t) t.value = v.time || "";
    if(n) n.value = v.note || "";
    if(e && typeof v.ext==='string') e.value = v.ext;
    if(q){
      const values=[...q.options].map(o=>o.value);
      q.value = values.includes(n.value) ? n.value : "";
    }
    if(s) toggleRowByStatus(k, s.value, {silent:true});
  });
  recolor();
}
function saveLocal(){ try{ localStorage.setItem(storeKey, JSON.stringify(getState())); toast('保存しました'); }catch(_){} }
function loadLocal(){ try{ const raw=localStorage.getItem(storeKey); if(raw) applyState(JSON.parse(raw)); }catch(_){} }

/* ====== イベント ====== */
function wireEvents(){
  boardEl.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change", ()=>{ saveLocal(); pushRemoteThrottled(); });
  });
  // ステータス→time/note自動制御
  boardEl.querySelectorAll('select[name="status"]').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const key = sel.id.replace('status-','');
      toggleRowByStatus(key, sel.value);
      saveLocal(); pushRemoteThrottled();
    });
    const key = sel.id.replace('status-','');
    toggleRowByStatus(key, sel.value, {silent:true});
  });
  // 備考 候補⇄自由入力の同期
  boardEl.querySelectorAll(".quick").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const key = sel.id.replace("noteq-","");
      const input = document.getElementById(`note-${key}`);
      input.value = sel.value; saveLocal(); pushRemoteThrottled();
    });
  });
  boardEl.querySelectorAll(".free").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const key = inp.id.replace("note-","");
      const sel = document.getElementById(`noteq-${key}`);
      const values=[...sel.options].map(o=>o.value);
      sel.value = values.includes(inp.value) ? inp.value : "";
    });
  });
}
/* ステータスに応じて time/備考を制御 */
function toggleRowByStatus(key, status, opt={}){
  const timeSel = document.getElementById(`time-${key}`);
  const noteIn  = document.getElementById(`note-${key}`);
  const noteSel = document.getElementById(`noteq-${key}`);
  const row     = document.getElementById(`row-${key}`);
  if(STATUS_CLEAR.has(status)){
    timeSel.disabled = true;
    if(!opt.silent){ timeSel.value=""; noteIn.value=""; noteSel.value=""; }
  }else{
    timeSel.disabled = false;
  }
  if(row){ row.dataset.status = status; }
}
/* 見た目 */
function recolor(){
  boardEl.querySelectorAll("tbody tr").forEach(tr=>{
    tr.dataset.status = tr.querySelector('select[name="status"]').value;
  });
}

/* ====== 同期（JSONP） ====== */
let lastPushed=0;
async function pullRemote(){
  const url = `${REMOTE_ENDPOINT}?action=get&key=${encodeURIComponent(DATA_KEY)}&token=${encodeURIComponent(SESSION_TOKEN)}`;
  const res = await jsonp(url);
  if(!res) return;
  if(res.error){
    sessionStorage.removeItem(SESSION_KEY); SESSION_TOKEN="";
    showLogin("セッションが切れました。再ログインしてください。");
    return;
  }
  if(res.data){
    applyState(res.data);
    try{ localStorage.setItem(storeKey, JSON.stringify(Object.assign({}, getState(), res.data))); }catch(_){}
  }
}
async function pushRemote(){
  const payload = encodeURIComponent(JSON.stringify({updated:Date.now(), data:getStateForPush()}));
  const url = `${REMOTE_ENDPOINT}?action=set&key=${encodeURIComponent(DATA_KEY)}&data=${payload}&token=${encodeURIComponent(SESSION_TOKEN)}`;
  const res = await jsonp(url);
  if(res && res.error){
    sessionStorage.removeItem(SESSION_KEY); SESSION_TOKEN="";
    showLogin("セッションが切れました。再ログインしてください。");
  }
}
function pushRemoteThrottled(){ const now=Date.now(); if(now-lastPushed>1200){ lastPushed=now; pushRemote(); } }
function startRemoteSync(){
  const start = ()=>{ pullRemote(); setInterval(()=>pullRemote(), POLL_MS + Math.floor(Math.random()*1000)); };
  setTimeout(start, Math.floor(Math.random()*POLL_MS));
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) pullRemote(); });
  window.addEventListener('focus', pullRemote);
  window.addEventListener('storage', (e)=>{ if(e.key===storeKey && e.newValue){ try{ applyState(JSON.parse(e.newValue)); }catch(_){} } });
}

/* ====== 起動 ====== */
async function bootAfterLogin(){
  await loadConfig();     // 名簿・グループ（タイトル・内線初期値）をAPIから取得
  render();               // 初描画
  startRemoteSync();
}
document.addEventListener('DOMContentLoaded', ()=>{
  window.__doLogin = () => login(pwInput.value);
  document.getElementById('btnLogin').addEventListener('click', window.__doLogin);
  pwInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') window.__doLogin(); });

  if(requireToken()){
    hideLogin();
    bootAfterLogin();
  }else{
    showLogin();
  }
});
/* JSエラーを画面表示 */
window.addEventListener('error', e=>{
  toastEl.style.background='#c53030';
  toastEl.textContent='エラー: '+e.message; toastEl.classList.add('show');
});
</script>
</body>
</html>
