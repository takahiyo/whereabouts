/** 在席表 同期API（JSONP）: 共通パスワード→短命トークン発行→get/set/renew + Cache */
const PASSWORD      = 'NagoChu6261';    // 共通パスワード
const TOKEN_TTL_MS  = 60 * 60 * 1000;   // 60分
const TOKEN_PREFIX  = 'tok_';
const CACHE_TTL_SEC = 20;               // ★ getの結果を20秒キャッシュ（全体で共用）

const KEY_PREFIX    = 'presence:';      // Cache用キー接頭辞

function now(){ return Date.now(); }
function outJSONP(cb, obj){
  return ContentService.createTextOutput(cb + '(' + JSON.stringify(obj) + ')')
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function doGet(e) {
  var cb     = (e && e.parameter && e.parameter.callback) || 'callback';
  var action = (e && e.parameter && e.parameter.action)   || 'get';
  var prop   = PropertiesService.getScriptProperties();
  var cache  = CacheService.getScriptCache();

  // 期限切れトークンの掃除（ランダム）
  try {
    if (Math.random() < 0.02) {
      var all = prop.getProperties(), t=now();
      for (var k in all) if (k.indexOf(TOKEN_PREFIX)===0) {
        var exp = Number(all[k] || 0);
        if (!exp || exp < t) prop.deleteProperty(k);
      }
    }
  } catch (_) {}

  // login
  if (action === 'login') {
    var pw = (e.parameter && e.parameter.password) || '';
    if (pw !== PASSWORD) return outJSONP(cb, { error: 'unauthorized' });
    var token = Utilities.getUuid();
    prop.setProperty(TOKEN_PREFIX + token, String(now() + TOKEN_TTL_MS));
    return outJSONP(cb, { token: token, exp: TOKEN_TTL_MS });
  }

  // renew
  if (action === 'renew') {
    var rtoken = (e.parameter && e.parameter.token) || '';
    var rexp   = Number(prop.getProperty(TOKEN_PREFIX + rtoken) || 0);
    if (!rexp || rexp < now()) return outJSONP(cb, { error: 'unauthorized' });
    prop.setProperty(TOKEN_PREFIX + rtoken, String(now() + TOKEN_TTL_MS));
    return outJSONP(cb, { ok: true, exp: TOKEN_TTL_MS });
  }

  // ここから先はトークン必須
  var token = (e.parameter && e.parameter.token) || '';
  var exp   = Number(prop.getProperty(TOKEN_PREFIX + token) || 0);
  if (!exp || exp < now()) return outJSONP(cb, { error: 'unauthorized' });

  var key = (e.parameter && e.parameter.key) || 'presence-board-default';
  var pKey = KEY_PREFIX + key;

  if (action === 'set') {
    var data = (e.parameter && e.parameter.data) || '{"updated":0,"data":{}}';
    prop.setProperty(key, data);
    cache.put(pKey, data, CACHE_TTL_SEC);   // ★ キャッシュも更新
    return outJSONP(cb, { ok: true });
  }

  // get：Cache→Propertiesの順
  var hit = cache.get(pKey);
  if (hit) {
    try { return outJSONP(cb, JSON.parse(hit)); }
    catch (err) { /* キャッシュ破損時は下へフォールバック */ }
  }

  var v = prop.getProperty(key) || '{"updated":0,"data":{}}';
  try {
    cache.put(pKey, v, CACHE_TTL_SEC);      // ★ キャッシュ登録
    return outJSONP(cb, JSON.parse(v));
  } catch (err) {
    return outJSONP(cb, { updated: 0, data: {} });
  }
}
