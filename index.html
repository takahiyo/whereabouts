<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表</title>
<style>
  :root{
    --line:#d9d9d9; --head:#f1ece6; --bg:#fafafa;
    --present:#e8f6e8; --away:#fff3e6; --remote:#e8f0ff; --off:#f7e8ee; --home:#ffe8f0;
  }
  body{font-family:"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff;margin:16px}
  header{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:12px;flex-wrap:wrap}
  header h1{font-size:14px;font-weight:600;color:#4a5568;margin:0;padding:.35rem .9rem;background:#dff1ff;border-radius:999px}
  header .tools{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  button{border:1px solid var(--line);background:#fff;padding:.45rem .7rem;border-radius:8px;cursor:pointer}
  button:hover{background:#f7f7f7}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* ボード（最小幅を拡大） */
  .board{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:18px}
  .panel{border:1px solid var(--line);border-radius:6px;background:var(--bg);padding:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--head);font-weight:700}
  th,td{border:1px solid var(--line);padding:6px;font-size:14px}
  th{text-align:left}

  /* 列幅：ステータス/備考を広めに、時間は通常幅 */
  td.name{background:#fff;width:18%}
  td.status{width:34%}     /* ← もう1文字分広げる */
  td.time{width:18%}
  td.note{width:30%}

  /* コントロール共通 */
  select,input[type="text"]{
    width:100%;box-sizing:border-box;padding:.3rem .35rem;border:1px solid var(--line);
    border-radius:4px;background:#fff;font-size:14px;appearance:auto;-webkit-appearance:auto
  }
  /* 戻り時間はセル幅の 75% に */
  td.time select{width:75%}

  /* 備考：クイック選択＋自由入力の並び */
  .note .note-wrap{display:flex;gap:6px;align-items:center}
  .note .note-quick{flex:0 0 7.5em}
  .note .note-input{flex:1 1 auto}

  /* ステータス色 */
  tr[data-status="在席"]{background:var(--present)}
  tr[data-status="外出"]{background:var(--away)}
  tr[data-status="休み"],tr[data-status="健康診断"],tr[data-status="コアドック"]{background:var(--off)}
  tr[data-status="帰宅"]{background:var(--home)}
  tr[data-status="在宅勤務"]{background:var(--remote)}
  tr[data-status="出張"],tr[data-status="研修"]{background:var(--away)}

  .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:8px 12px;border-radius:4px;font-size:12px;opacity:0;transition:.25s;z-index:9999}
  .toast.show{opacity:1}

  @media(max-width:768px){.board{grid-template-columns:1fr;gap:12px}header{flex-direction:column;gap:12px}header .tools{margin-left:0;justify-content:center}body{margin:8px}button{font-size:14px;padding:.4rem .6rem}}
  @media print{header,.toast{display:none}body{margin:0}.board{gap:10px}th,td{font-size:12px;padding:4px}}
</style>
</head>
<body>
  <header>
    <h1>在席確認表（幅調整・同期準備）</h1>
    <div class="tools">
      <button id="printBtn">印刷</button>
    </div>
  </header>

  <div id="toast" class="toast"></div>
  <div class="board" id="board"></div>

<script>
/* ====== 端末間共有（任意） ======
   REMOTE_ENDPOINT を自分の Google Apps Script WebアプリURLにすると
   端末間で状態が共有されます。未設定ならローカル保存のみ。 */
const REMOTE_ENDPOINT = ""; // 例: "https://script.google.com/macros/s/AKfycb.../exec"
const REMOTE_KEY = "presence-board-default"; // 同じURLでもキーを変えれば別ボードにできます
const REMOTE_POLL_MS = 10000;

/* ====== 定数 ====== */
const board = document.getElementById('board');
const toast = document.getElementById('toast');
const storeKey = 'presence-board-v2-min';
const STATUSES = ["在席","外出","休み","帰宅","在宅勤務","出張","研修","健康診断","コアドック"];

/* ====== 名簿（画像準拠） ====== */
const groups = [
  ["村田","今泉","北村","大野","長谷川","横内"],                 // 左上
  ["佐藤","井上","折原","金村","水野","坪井"],                     // 左下
  ["清水","加藤","石垣","橋本","末永","田中光","大石","井山"],     // 中上
  ["飯島","能登","松浦","永峯","清","長森","山本"],                 // 中下
  ["伊藤隆","小森","三浦","中村純","朝井","稲葉"],                 // 右上
  ["吉田","阿部","伊藤裕","中村清","平良","若山","竹森","平八重"], // 右中
  ["鈴木","中村亮","江場","三島","吉田","小川","伊藤尊"]           // 中央下
];

/* ====== 画面描画 ====== */
function timeOptions(){
  const opts=['<option value="">--</option>'];
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=30){
      const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      opts.push(`<option value="${t}">${t}</option>`);
    }
  }
  return opts.join('');
}
function rowHtml(gIndex,rIndex,name){
  const key=`${gIndex}-${rIndex}`;
  return `
  <tr id="row-${key}" data-key="${key}" data-status="在席">
    <td class="name">${name}</td>
    <td class="status">
      <label class="sr-only" for="status-${key}">ステータス</label>
      <select id="status-${key}" name="status">
        ${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join("")}
      </select>
    </td>
    <td class="time">
      <label class="sr-only" for="time-${key}">戻り時間</label>
      <select id="time-${key}" name="time">${timeOptions()}</select>
    </td>
    <td class="note">
      <div class="note-wrap">
        <select id="noteq-${key}" class="note-quick" aria-label="備考（候補）">
          <option value="">（空白）</option>
          <option value="直出">直出</option>
          <option value="直帰">直帰</option>
          <option value="直出/直帰">直出/直帰</option>
          <option value="__DIRECT__">（直接入力）</option>
        </select>
        <input id="note-${key}" class="note-input" name="note" type="text" placeholder="備考" />
      </div>
    </td>
  </tr>`;
}
function panelHtml(gIndex,names){
  return `
  <section class="panel">
    <table aria-label="在席表">
      <thead><tr><th>氏名</th><th>ステータス</th><th>戻り時間</th><th>備考</th></tr></thead>
      <tbody>${names.map((n,i)=>rowHtml(gIndex,i,n)).join("")}</tbody>
    </table>
  </section>`;
}
function render(){
  board.innerHTML = groups.map((g,i)=>panelHtml(i,g)).join('');
  attachHandlers();
  loadState();
  recalcRowColors();
}

/* ====== ハンドラ ====== */
let lastPushed = 0;
function attachHandlers(){
  board.querySelectorAll("select,input").forEach(el=>{
    el.addEventListener("change", ()=>{saveState();recalcRowColors();pushRemoteThrottled();});
  });
  // 備考クイック選択 → 入力欄に反映
  board.querySelectorAll(".note-quick").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const key = sel.id.replace("noteq-","");
      const input = document.getElementById(`note-${key}`);
      if(sel.value === "__DIRECT__"){ input.focus(); return; }
      input.value = sel.value; // 空白もOK（""）
      saveState(); pushRemoteThrottled();
    });
  });
}

/* ====== 保存（ローカル） ====== */
function getState(){
  const data={};
  board.querySelectorAll("tbody tr").forEach(tr=>{
    const k=tr.dataset.key;
    data[k]={
      status: tr.querySelector('select[name="status"]').value,
      time:   tr.querySelector('select[name="time"]').value,
      note:   tr.querySelector('.note-input').value
    };
  });
  return data;
}
function saveState(){ localStorage.setItem(storeKey, JSON.stringify(getState())); toastOnce('保存しました'); }
function loadState(){
  const raw = localStorage.getItem(storeKey);
  if(!raw) return;
  const data = JSON.parse(raw);
  Object.entries(data).forEach(([k,v])=>{
    const s=document.getElementById(`status-${k}`),
          t=document.getElementById(`time-${k}`),
          n=document.getElementById(`note-${k}`);
    if(s && STATUSES.includes(v.status)) s.value=v.status;
    if(t && v.time) t.value=v.time;
    if(n !== null && v.note !== undefined) n.value=v.note;
  });
}

/* ====== 端末間同期（GASエンドポイントが設定されている場合のみ） ====== */
async function pullRemote(){
  if(!REMOTE_ENDPOINT) return;
  try{
    const res = await fetch(`${REMOTE_ENDPOINT}?key=${encodeURIComponent(REMOTE_KEY)}`, {cache:'no-store'});
    if(!res.ok) return;
    const remote = await res.json();             // { data: {...}, updated: 169... }
    if(!remote || !remote.data) return;
    // マージ（単純上書き）
    const local = getState();
    const merged = Object.assign({}, local, remote.data);
    applyState(merged);
    localStorage.setItem(storeKey, JSON.stringify(merged));
  }catch(e){/* 無視（オフライン等） */}
}
function applyState(data){
  Object.entries(data).forEach(([k,v])=>{
    const s=document.getElementById(`status-${k}`),
          t=document.getElementById(`time-${k}`),
          n=document.getElementById(`note-${k}`);
    if(s && STATUSES.includes(v.status)) s.value=v.status;
    if(t) t.value = v.time || "";
    if(n) n.value = v.note || "";
  });
  recalcRowColors();
}
async function pushRemote(){
  if(!REMOTE_ENDPOINT) return;
  try{
    const payload = { key: REMOTE_KEY, data: getState(), updated: Date.now() };
    await fetch(REMOTE_ENDPOINT, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  }catch(e){/* 無視 */}
}
function pushRemoteThrottled(){
  const now = Date.now();
  if(now - lastPushed > 1500){ lastPushed = now; pushRemote(); }
}
function startRemoteSync(){
  if(!REMOTE_ENDPOINT) return;
  pullRemote();                       // 初回取得
  setInterval(pullRemote, REMOTE_POLL_MS); // ポーリング
}

/* ====== 見た目 ====== */
function recalcRowColors(){
  board.querySelectorAll("tbody tr").forEach(tr=>{
    tr.dataset.status = tr.querySelector('select[name="status"]').value;
  });
}
function toastOnce(msg){
  toast.textContent = msg; toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 1000);
}

/* ====== 起動 ====== */
document.getElementById('printBtn').addEventListener('click',()=>window.print());
document.addEventListener('DOMContentLoaded', ()=>{
  render();
  startRemoteSync();
});

/* スクリプトエラーを画面表示（デバッグ用） */
window.addEventListener('error', e=>{
  toast.style.background='#c53030'; toast.textContent = 'エラー: ' + e.message; toast.classList.add('show');
});
</script>
</body>
</html>
