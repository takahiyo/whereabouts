<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>在席確認表</title>

<style>
  :root{
    --base-name:   120px;
    --base-ext:     70px;
    --base-status: 170px;
    --base-time:    65px;
    --base-note:   210px;

    --scale-name:   0.50;
    --scale-ext:    0.33;
    --scale-status: 0.75;
    --scale-time:   0.45;

    --min-name:    85px;
    --min-ext:     35px;
    --min-status:  85px;
    --min-time:    65px;
    --min-note:   70px;

    --w-name:   max(calc(var(--base-name)   * var(--scale-name)),   var(--min-name));
    --w-ext:    max(calc(var(--base-ext)    * var(--scale-ext)),    var(--min-ext));
    --w-status: max(calc(var(--base-status) * var(--scale-status)), var(--min-status));
    --w-time:   max(calc(var(--base-time)   * var(--scale-time)),   var(--min-time));
    --w-note:   max(var(--base-note), var(--min-note));

    --status-effective: var(--status-fixed, var(--w-status));

    --gap: 20px;
    --line:#d9d9d9; --head:#f1ece6; --bg:#fafafa;
    --present:#e8f6e8; --away:#fff3e6; --remote:#e8f0ff; --off:#f7e8ee; --home:#ffe8f0;

    --header-height: 56px;
  }

  html{ scroll-behavior:smooth; }
  body{font-family:"Segoe UI","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#fff;margin:16px}

  /* 固定ヘッダ（タイトル=ジャンプボタン／管理ボタン／ログオフ） */
  header{
    position: sticky; top: 0; z-index: 1500;
    display:flex; gap:8px; align-items:center; justify-content:center;
    margin-bottom:12px; flex-wrap:wrap; background:#fff;
    padding:6px 0; box-shadow: 0 1px 0 rgba(0,0,0,.06);
  }
  header .title-btn, header .admin-btn, header .logout-btn{
    font-size:14px; font-weight:600; color:#1f2937;
    padding:.35rem .9rem; background:#dff1ff; border-radius:999px;
    border:1px solid #bfe4ff; cursor:pointer; line-height:1.2;
  }
  header .admin-btn{ background:#e7f8e7; border-color:#b7e6b7; display:none; }
  header .logout-btn{ background:#fee2e2; border-color:#fecaca; display:none; }
  header .title-btn:hover{ background:#cfe9ff; }
  header .admin-btn:hover{ background:#d5f2d5; }
  header .logout-btn:hover{ background:#fde8e8; }
  header .title-btn:focus, header .admin-btn:focus, header .logout-btn:focus{ outline:3px solid #93c5fd; outline-offset:2px; }

  /* グループメニュー（ドロップダウン） */
  .grp-menu{
    position: fixed; top: calc(var(--header-height) + 8px); left: 50%;
    transform: translateX(-50%);
    background:#fff; border:1px solid var(--line); border-radius:10px;
    box-shadow:0 8px 24px rgba(0,0,0,.12);
    min-width: 260px; max-width: 92vw; max-height: 60vh; overflow:auto;
    padding:8px; z-index: 1600; display:none;
  }
  .grp-menu.show{ display:block; }
  .grp-menu h4{ font-size:12px; color:#6b7280; margin:4px 8px; }
  .grp-menu ul{ list-style:none; padding:0; margin:4px 0; }
  .grp-menu li{ margin:0; }
  .grp-menu button.grp-item{
    width:100%; text-align:left; border:0; background:transparent; cursor:pointer;
    padding:10px 12px; border-radius:8px; font-size:14px; color:#111827;
  }
  .grp-menu button.grp-item:hover{ background:#f3f4f6; }
  .grp-menu .muted{ color:#6b7280; }

  /* 管理モーダル */
  .admin-modal{ position:fixed; inset:0; z-index:1800; display:none; }
  .admin-modal.show{ display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5); }
  .admin-card{
    background:#fff; border:1px solid var(--line); border-radius:12px; padding:16px;
    width:min(960px, 94vw); max-height:80vh; overflow:auto;
  }
  .admin-card h3{ margin:4px 0 12px; }
  .admin-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .admin-box{ border:1px solid var(--line); border-radius:10px; padding:12px; }
  .admin-box h4{ margin:0 0 8px; font-size:14px; color:#374151; }
  .admin-row{ display:flex; gap:8px; align-items:center; margin:6px 0; flex-wrap:wrap; }
  .admin-row input, .admin-row select{ padding:.35rem .45rem; border:1px solid var(--line); border-radius:6px; min-width:120px; }
  .admin-row button{ padding:.35rem .6rem; border-radius:8px; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer; }
  .admin-row button:hover{ background:#eef2f7; }
  .admin-note{ font-size:12px; color:#6b7280; overflow-wrap:anywhere; word-break:break-word; white-space:normal; } /* 長文折返し */

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  .wrap{width:100%; margin:0 auto;}
  .board{
    display:grid; gap:var(--gap);
    grid-template-columns: repeat(var(--cols, 1), minmax(0, 1fr));
  }

  .panel{
    border:1px solid var(--line);border-radius:6px;background:var(--bg);padding:8px;overflow:auto;
    scroll-margin-top: calc(var(--header-height) + 12px);
  }
  .panel .title{font-weight:700;color:#6B7280;background:#f7f7f7;border:1px solid var(--line);border-radius:4px;padding:6px 8px;margin:0 0 6px 0;min-height:1.8em}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:#f2efe9;font-weight:700}
  th,td{border:1px solid var(--line);padding:6px;font-size:14px}
  th{text-align:left}

  col.col-name{width:var(--w-name)}
  col.col-ext{width:var(--w-ext)}
  col.col-status{width:var(--status-effective)}
  col.col-time{width:var(--w-time)}
  col.col-note{width:var(--w-note)}

  select,input[type="text"]{width:100%;box-sizing:border-box;padding:.3rem .35rem;border:1px solid var(--line);border-radius:4px;background:#fff;font-size:14px;appearance:auto;-webkit-appearance:auto}
  td.status{min-width: var(--status-effective)}
  td.status select{padding-right:2.6em}
  td.time select{text-align-last:center;font-variant-numeric:tabular-nums}

  tr[data-status="在席"]{background:var(--present)}
  tr[data-status="外出"]{background:var(--away)}
  tr[data-status="休み"],tr[data-status="健康診断"],tr[data-status="コアドック"]{background:var(--off)}
  tr[data-status="帰宅"]{background:var(--home)}
  tr[data-status="在宅勤務"]{background:var(--remote)}
  tr[data-status="出張"],tr[data-status="研修"]{background:var(--away)}

  .toast{position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:8px 12px;border-radius:4px;font-size:12px;opacity:0;transition:.25s;z-index:2000}
  .toast.show{opacity:1}

  /* ログイン（拠点選択＋パスワード） */
  .login{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2200}
  .login .card{background:#fff;border-radius:8px;padding:20px;min-width:300px;max-width:90vw;text-align:center}
  .login .card h2{margin:.2rem 0 1rem}
  .login .card input,.login .card select{margin:.4rem 0}

  @media print{header,.toast,.login,.admin-modal{display:none} body{margin:0}.board{gap:10px} th,td{font-size:12px;padding:4px}}

  /* スマホカード表示 */
  @media (max-width: 720px){
    colgroup, thead{ display:none; }
    table{ table-layout:auto; }
    tbody{ display:block; }

    tbody tr{
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      padding:10px;
      margin:10px 0;
    }

    tbody td{
      border:none;
      padding:0;
      display:flex;
      align-items:center;
      gap:8px;
      flex:1 1 48%;
      min-width:160px;
      background:transparent;
    }

    tbody td::before{
      content: attr(data-label);
      font-weight:600;
      color:#6B7280;
      min-width:5.5em;
      flex:0 0 auto;
    }

    tbody td.name{
      order:0;
      flex:1 1 100%;
      font-weight:800;
      font-size:15px;
      line-height:1.2;
      padding-bottom:2px;
    }
    tbody td.name::before{ content:""; display:none; }

    tbody td.ext    { order:1; }
    tbody td.time   { order:2; }
    tbody td.status { order:3; }
    tbody td.note   { order:4; flex:1 1 100%; }

    select, input[type="text"]{ width:100%; }
    td.status select{ padding-right:2.0em; }
  }
</style>
</head>

<body>
  <header>
    <button id="titleBtn" class="title-btn" aria-haspopup="true" aria-expanded="false" aria-controls="groupMenu">
      在席確認表
    </button>
    <button id="adminBtn" class="admin-btn" title="管理">管理</button>
    <button id="logoutBtn" class="logout-btn" title="ログオフ">ログオフ</button>
  </header>

  <!-- グループメニュー -->
  <div id="groupMenu" class="grp-menu" role="menu" aria-labelledby="titleBtn">
    <h4 id="groupMenuTitle">グループにジャンプ</h4>
    <ul id="groupMenuList"></ul>
  </div>

  <!-- 管理モーダル -->
  <div id="adminModal" class="admin-modal">
    <div class="admin-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <h3>管理パネル</h3>
        <button id="adminClose">閉じる</button>
      </div>

      <div class="admin-box">
        <div id="adminOfficeRow" class="admin-row">
          <label for="adminOfficeSel">対象拠点：</label>
          <select id="adminOfficeSel"></select>
          <button id="refreshOffices">更新</button>
          <span class="admin-note">（スーパ管理者は拠点を選択可能／拠点管理者は自拠点固定）</span>
        </div>
      </div>

      <div class="admin-grid" style="margin-top:10px;">
        <div class="admin-box">
          <h4>CSVエクスポート</h4>
          <div class="admin-row">
            <button id="btnExport">ダウンロード</button>
          </div>
          <div class="admin-note">フォーマット：group_index,group_title,member_order,id,name,ext,status,time,note</div>
        </div>

        <div class="admin-box">
          <h4>CSVインポート（正規CSV）</h4>
          <div class="admin-row">
            <input type="file" id="csvFile" accept=".csv,text/csv" />
            <button id="btnImport">取り込み</button>
          </div>
          <div class="admin-note">名簿→在席の順で安全に更新します。大きい場合は自動分割送信します。</div>
        </div>

        <div class="admin-box">
          <h4>拠点名の変更</h4>
          <div class="admin-row">
            <input id="renameOfficeName" placeholder="新しい拠点名" />
            <button id="btnRenameOffice">変更</button>
          </div>
        </div>

        <div class="admin-box" data-super-only="1">
          <h4>拠点の追加</h4>
          <div class="admin-row">
            <input id="addOfficeId" placeholder="ID（半角英数_-）" />
            <input id="addOfficeName" placeholder="拠点名" />
            <input id="addOfficePw" placeholder="パスワード" />
            <input id="addOfficeAdminPw" placeholder="管理者PW" />
            <button id="btnAddOffice">追加</button>
          </div>
        </div>

        <div class="admin-box" data-super-only="1">
          <h4>拠点の削除</h4>
          <div class="admin-row">
            <button id="btnDeleteOffice" style="background:#fee2e2;border-color:#fecaca;">この拠点を削除</button>
          </div>
          <div class="admin-note">復元不可。名簿・在席データともに削除されます。</div>
        </div>

        <div class="admin-box">
          <h4>拠点パスワードの変更</h4>
          <div class="admin-row">
            <input id="setPw" placeholder="新パスワード（任意）" />
            <input id="setAdminPw" placeholder="新管理者PW（任意）" />
            <button id="btnSetPw">更新</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ログイン -->
  <div id="login" class="login" style="display:none">
    <div class="card">
      <h2>在席確認表</h2>
      <p>拠点を選び、パスワードを入力してください</p>
      <label class="sr-only" for="officeSel">拠点</label>
      <select id="officeSel">
        <option value="nagoya" selected>名古屋中央営業所</option>
        <option value="test">Administrator</option>
      </select>
      <input type="password" id="pw" placeholder="Password" />
      <button id="btnLogin" onclick="window.__doLogin && window.__doLogin()">ログイン</button>
      <div id="loginMsg" style="color:#0073bb;margin-top:8px" aria-live="polite"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div class="wrap">
    <div id="board" class="board" style="display:none"></div>
  </div>

<script>
/* ===== 接続設定（GAS Webアプリ） ===== */
const REMOTE_ENDPOINT = "https://script.google.com/macros/s/AKfycbxaRATd8G1wwiTwu_vaGMhvk5HxOnLeP90N6e4IbWPfWYQeTI-qSBklFZGi6GbIG-oe/exec";
const REMOTE_POLL_MS  = 2000;
const CONFIG_POLL_MS  = 120000;
const SESSION_KEY     = "presence-session-token";
const TOKEN_DEFAULT_TTL = 3600000;

/* レイアウト */
const PANEL_MIN_PX = 760;
const GAP_PX = 20;
const MAX_COLS = 3;

/* 名簿とUI要素 */
let GROUPS = [];
let CONFIG_UPDATED = 0;
let tokenRenewTimer = null;

const board   = document.getElementById('board');
const toastEl = document.getElementById('toast');
const loginEl = document.getElementById('login');
const loginMsg= document.getElementById('loginMsg');
const pwInput = document.getElementById('pw');
const officeSel = document.getElementById('officeSel');

const menuEl   = document.getElementById('groupMenu');
const menuList = document.getElementById('groupMenuList');
const menuTitle= document.getElementById('groupMenuTitle');
const titleBtn = document.getElementById('titleBtn');

const adminBtn = document.getElementById('adminBtn');
const logoutBtn= document.getElementById('logoutBtn');
const adminModal = document.getElementById('adminModal');
const adminClose = document.getElementById('adminClose');

const adminOfficeRow = document.getElementById('adminOfficeRow');
const adminOfficeSel = document.getElementById('adminOfficeSel');
const refreshOfficesBtn = document.getElementById('refreshOffices');

const btnExport = document.getElementById('btnExport');
const csvFile   = document.getElementById('csvFile');
const btnImport = document.getElementById('btnImport');

const renameOfficeName = document.getElementById('renameOfficeName');
const btnRenameOffice  = document.getElementById('btnRenameOffice');

const addOfficeId   = document.getElementById('addOfficeId');
const addOfficeName = document.getElementById('addOfficeName');
const addOfficePw   = document.getElementById('addOfficePw');
const addOfficeAdminPw = document.getElementById('addOfficeAdminPw');
const btnAddOffice  = document.getElementById('btnAddOffice');

const btnDeleteOffice = document.getElementById('btnDeleteOffice');

const setPw      = document.getElementById('setPw');
const setAdminPw = document.getElementById('setAdminPw');
const btnSetPw   = document.getElementById('btnSetPw');

const STATUSES = ["在席","外出","休み","帰宅","在宅勤務","出張","研修","健康診断","コアドック"];
const CLEAR_ON = new Set(["在席","休み","帰宅","在宅勤務"]);
const storeKey = "presence-board-v3";

/* タイマー・オブザーバ管理 */
let ro = null;
let remotePullTimer = null;
let remoteStartTimer = null;
let configWatchTimer = null;

/* 認証状態 */
let SESSION_TOKEN = "";
let CURRENT_OFFICE_NAME = "";
let CURRENT_OFFICE_ID = "";
let CURRENT_ROLE = "user"; // 'user' | 'officeAdmin' | 'superAdmin'

function isSuper(){ return CURRENT_ROLE === 'superAdmin'; }
function isOfficeAdmin(){ return CURRENT_ROLE === 'officeAdmin'; }

/* レイアウト */
function getContainerWidth(){
  const el = board.parentElement || document.body;
  const r = el.getBoundingClientRect();
  return Math.max(0, Math.round(r.width));
}
function updateCols(){
  const w = getContainerWidth();
  let n = Math.floor((w + GAP_PX) / (PANEL_MIN_PX + GAP_PX));
  if(!Number.isFinite(n) || n < 1) n = 1;
  if(n > MAX_COLS) n = MAX_COLS;
  board.style.setProperty('--cols', n);
}
function startGridObserver(){
  if(ro) ro.disconnect();
  ro = new ResizeObserver(updateCols);
  ro.observe(board.parentElement || document.body);
  window.addEventListener('resize', updateCols, {passive:true});
  updateCols();
}

/* 名簿（構成）整形 */
function makeLocalId(s){
  const seed = (s||"").normalize('NFKC').replace(/\s+/g,'');
  let h = 0; for(let i=0;i<seed.length;i++){ h = (h*31 + seed.charCodeAt(i)) >>> 0; }
  return "P" + (h.toString(16) + "00000000").slice(0,8);
}
function normalizeConfigClient(cfg){
  if(!cfg || !Array.isArray(cfg.groups)) return [];
  return cfg.groups.map(g=>({
    title: String(g.title || ""),
    members: (Array.isArray(g.members) ? g.members : []).map(m=>{
      const name = String((m && m.name) || "");
      const ext  = (m && m.ext) ? String(m.ext) : "";
      let id     = (m && m.id) ? String(m.id) : "";
      if(!/^[A-Za-z0-9_-]+$/.test(id)) id = makeLocalId(name+ext);
      return { name, ext, id };
    })
  }));
}
function fallbackGroupTitle(g, idx){
  const t = (g && typeof g.title === 'string' ? g.title.trim() : "");
  return t || `グループ${idx+1}`;
}

/* テーブル UI生成 */
function timeOptions(){
  const opts=['<option value=""></option>'];
  for(let h=0;h<24;h++){ for(let m=0;m<60;m+=30){
    const t=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    opts.push(`<option value="${t}">${t}</option>`);
  } }
  return opts.join('');
}
function rowHtml(member){
  const name= member.name || "";
  const ext = (member.ext && /^[0-9]{1,4}$/.test(String(member.ext))) ? String(member.ext) : "";
  const key = member.id;
  return `
    <tr id="row-${key}" data-key="${key}" data-status="在席">
      <td class="name"  data-label="氏名">${name}</td>
      <td class="ext"   data-label="内線">
        <label class="sr-only" for="ext-${key}">内線</label>
        <input id="ext-${key}" name="ext" type="text" maxlength="4" inputmode="numeric" pattern="^[0-9]{0,4}$" placeholder="内線" value="${ext}" />
      </td>
      <td class="status" data-label="ステータス">
        <label class="sr-only" for="status-${key}">ステータス</label>
        <select id="status-${key}" name="status">${STATUSES.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>
      </td>
      <td class="time"   data-label="戻り時間">
        <label class="sr-only" for="time-${key}">戻り時間</label>
        <select id="time-${key}" name="time">${timeOptions()}</select>
      </td>
      <td class="note"   data-label="備考">
        <input id="note-${key}" name="note" type="text" list="noteOptions" placeholder="備考" />
      </td>
    </tr>`;
}
function panelHtml(group, idx){
  const gid = `grp-${idx}`;
  const title = fallbackGroupTitle(group, idx);
  return `
    <section class="panel" id="${gid}" data-group-index="${idx}">
      <h3 class="title">${title}</h3>
      <table aria-label="在席表（${title}）">
        <colgroup>
          <col class="col-name"><col class="col-ext"><col class="col-status"><col class="col-time"><col class="col-note">
        </colgroup>
        <thead><tr><th>氏名</th><th>内線</th><th>ステータス</th><th>戻り時間</th><th>備考</th></tr></thead>
        <tbody>${group.members.map(m=>rowHtml(m)).join("")}</tbody>
      </table>
    </section>`;
}
function render(){
  board.innerHTML = GROUPS.map((g,i)=>panelHtml(g,i)).join('');
  board.style.display = '';
  wireEvents();
  loadLocal();
  recolor();
  startGridObserver();
  buildGroupMenu();
}

/* グループメニュー */
function buildGroupMenu(){
  if(!Array.isArray(GROUPS)) return;
  const total = GROUPS.reduce((sum, g) => sum + ((g.members && g.members.length) || 0), 0);
  if(menuTitle){ menuTitle.textContent = 'グループにジャンプ'; }

  const items = [];
  items.push(`<li><button class="grp-item" role="menuitem" data-target="top">全体（合計：${total}名）</button></li>`);
  GROUPS.forEach((g,i)=>{
    const title = fallbackGroupTitle(g,i);
    const sub = (g && g.members && g.members.length) ? `（${g.members.length}名）` : '（0名）';
    items.push(`<li><button class="grp-item" role="menuitem" data-target="grp-${i}">${title} <span class="muted">${sub}</span></button></li>`);
  });
  menuList.innerHTML = items.join('');

  menuList.querySelectorAll('button.grp-item').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-target');
      closeMenu();
      if(id === 'top'){ window.scrollTo({ top: 0, behavior: 'smooth' }); return; }
      const sec = document.getElementById(id);
      if(sec){ sec.scrollIntoView({behavior:'smooth', block:'start'}); }
    });
  });
}
function openMenu(){ menuEl.classList.add('show'); titleBtn.setAttribute('aria-expanded','true'); }
function closeMenu(){ menuEl.classList.remove('show'); titleBtn.setAttribute('aria-expanded','false'); }
function toggleMenu(){ if(menuEl.classList.contains('show')) closeMenu(); else openMenu(); }
titleBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
document.addEventListener('click', (e)=>{ if(menuEl.classList.contains('show')){ const within = menuEl.contains(e.target) || titleBtn.contains(e.target); if(!within) closeMenu(); } });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMenu(); });

/* 行状態 */
function getRowStateByTr(tr){
  if(!tr) return {ext:"",status:"在席",time:"",note:""};
  return {
    ext:   tr.querySelector('input[name="ext"]').value.trim(),
    status:tr.querySelector('select[name="status"]').value,
    time:  tr.querySelector('select[name="time"]').value,
    note:  tr.querySelector('input[name="note"]').value
  };
}
function getRowState(id){ return getRowStateByTr(document.getElementById(`row-${id}`)); }
function getState(){
  const data={};
  board.querySelectorAll("tbody tr").forEach(tr=>{
    data[tr.dataset.key]=getRowStateByTr(tr);
  });
  return data;
}

/* 適用：編集中は上書きしない */
function isEditingField(el){
  if(!el) return false;
  if(el.dataset && el.dataset.editing === '1') return true;
  if(el.dataset && el.dataset.composing === '1') return true;
  if(el === document.activeElement) return true;
  return false;
}
function setIfNeeded(el, newVal){
  if(!el) return;
  if(isEditingField(el)) return;
  if(el.value !== (newVal ?? "")) el.value = newVal ?? "";
}
function applyState(data){
  if(!data) return;
  Object.entries(data).forEach(([k,v])=>{
    const e=document.getElementById(`ext-${k}`);
    const s=document.getElementById(`status-${k}`);
    const t=document.getElementById(`time-${k}`);
    const n=document.getElementById(`note-${k}`);

    if(typeof v.ext==="string")  setIfNeeded(e, v.ext);
    if(v.status && STATUSES.includes(v.status)) setIfNeeded(s, v.status);
    setIfNeeded(t, v.time || "");
    setIfNeeded(n, v.note || "");

    if(s && t) toggleTimeEnable(s, t);
  });
  recolor();
}

function saveLocal(){ try{ localStorage.setItem(storeKey, JSON.stringify(getState())); }catch(e){} }
function loadLocal(){ try{ const raw=localStorage.getItem(storeKey); if(raw) applyState(JSON.parse(raw)); }catch(e){} }

/* イベント&同期 */
const noteTimers = new Map();
function debounceRowPush(key, delay=900){
  if(noteTimers.has(key)) clearTimeout(noteTimers.get(key));
  noteTimers.set(key, setTimeout(()=>{ noteTimers.delete(key); pushRowDelta(key); }, delay));
}
function markEditing(el){ if(!el) return; el.dataset.editing = '1'; }
function unmarkEditing(el){ if(!el) return; delete el.dataset.editing; }
function wireEvents(){
  board.querySelectorAll("input, select").forEach(el=>{
    el.addEventListener('focus', ()=> markEditing(el));
    el.addEventListener('blur',  ()=> unmarkEditing(el));
  });

  board.querySelectorAll("select[name='status']").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const key  = sel.id.replace("status-","");
      const time = document.getElementById(`time-${key}`);
      const note = document.getElementById(`note-${key}`);
      if(CLEAR_ON.has(sel.value)){ if(time) time.value=""; if(note) note.value=""; }
      if(time) toggleTimeEnable(sel, time);
      saveLocal(); pushRowDelta(key); recolor();
    });
  });
  board.querySelectorAll("select[name='time']").forEach(sel=>{
    sel.addEventListener("change", ()=>{ const key = sel.id.replace("time-",""); saveLocal(); pushRowDelta(key); });
  });
  board.querySelectorAll("input[name='ext']").forEach(inp=>{
    inp.addEventListener('change', ()=>{ const key = inp.id.replace("ext-",""); saveLocal(); pushRowDelta(key); });
  });
  board.querySelectorAll("input[name='note']").forEach(inp=>{
    const key = inp.id.replace("note-","");
    inp.addEventListener('compositionstart', ()=>{ inp.dataset.composing = '1'; });
    inp.addEventListener('compositionend',  ()=>{ inp.dataset.composing = ''; saveLocal(); pushRowDelta(key); });
    inp.addEventListener('input', ()=>{ saveLocal(); if(!inp.dataset.composing) debounceRowPush(key, 900); });
    inp.addEventListener('change', ()=>{ saveLocal(); pushRowDelta(key); });
  });
}
function toggleTimeEnable(statusEl, timeEl){
  const needsTime = ["外出","出張","研修"].includes(statusEl.value);
  if(timeEl) timeEl.disabled = !needsTime;
}
function recolor(){
  board.querySelectorAll("tbody tr").forEach(tr=>{
    tr.dataset.status = tr.querySelector('select[name="status"]').value;
  });
}

/* JSONP */
function jsonp(url, timeout=15000){
  return new Promise((resolve)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    let done=false;
    const cleanup=(s)=>{ try{ delete window[cb]; }catch(e){} if(s){ if(s.remove){s.remove();} else if(s.parentNode){s.parentNode.removeChild(s);} } };
    const timer=setTimeout(()=>{ if(!done){ done=true; cleanup(script); resolve(null); } }, timeout);
    window[cb]=(data)=>{ if(done) return; done=true; clearTimeout(timer); cleanup(script); resolve(data); };
    const script=document.createElement('script');
    script.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb + '&_=' + Date.now();
    script.onerror=()=>{ if(!done){ done=true; clearTimeout(timer); cleanup(script); resolve(null); } };
    document.body.appendChild(script);
  });
}

/* ===== 認証/セッション ===== */
function ensureAuthUI(){
  const showAdmin = (SESSION_TOKEN && (isSuper() || isOfficeAdmin()));
  adminBtn.style.display  = showAdmin ? 'inline-block' : 'none';
  logoutBtn.style.display = SESSION_TOKEN ? 'inline-block' : 'none';
}

/* ログアウト（非表示に戻す対応版） */
function logout(){
  try{
    if(tokenRenewTimer){ clearTimeout(tokenRenewTimer); tokenRenewTimer=null; }
    if(configWatchTimer){ clearInterval(configWatchTimer); configWatchTimer=null; }
    if(remoteStartTimer){ clearTimeout(remoteStartTimer); remoteStartTimer=null; }
    if(remotePullTimer){ clearInterval(remotePullTimer); remotePullTimer=null; }
    if(ro){ try{ ro.disconnect(); }catch(_){} }
  }catch(_){}  

  // 画面要素を即座に隠す＆消す
  closeMenu();
  showAdmin(false);
  board.style.display = 'none';
  if (board.replaceChildren) board.replaceChildren();
  else board.innerHTML = '';
  menuList.innerHTML = '';
  window.scrollTo(0, 0);

  // セッション情報のリセット
  SESSION_TOKEN = "";
  sessionStorage.removeItem(SESSION_KEY);

  CURRENT_OFFICE_NAME = "";
  CURRENT_OFFICE_ID = "";
  CURRENT_ROLE = "user";
  titleBtn.textContent = '在席確認表';
  ensureAuthUI();

  // ログイン画面を前面表示
  loginEl.style.display='flex';
}

/* ===== サーバ通信（通常ユーザ） ===== */
async function tryLoadGroupsFromServer(nocache=false){
  const url = `${REMOTE_ENDPOINT}?action=getConfig&token=${encodeURIComponent(SESSION_TOKEN)}${nocache?'&nocache=1':''}`;
  const cfg = await jsonp(url);
  if(!cfg || cfg.error) throw new Error('config_load_failed');
  const groups = normalizeConfigClient(cfg);
  if(!groups.length) throw new Error('config_empty');
  GROUPS = groups;
  CONFIG_UPDATED = (typeof cfg.updated === 'number') ? cfg.updated : 0;
}
async function fastFetchDataOnce(){
  const url = `${REMOTE_ENDPOINT}?action=get&token=${encodeURIComponent(SESSION_TOKEN)}&nocache=1`;
  return await jsonp(url);
}
async function pullRemote(){
  if(!SESSION_TOKEN) return;
  const remote = await fastFetchDataOnce();
  if(!remote){ return; }
  if(remote.error){ logout(); return; }
  if(remote.data){ applyState(remote.data); try{ localStorage.setItem(storeKey, JSON.stringify(Object.assign({}, getState(), remote.data))); }catch(e){} }
}
async function pushRowDelta(key){
  if(!SESSION_TOKEN) return;
  const payloadObj = {updated:Date.now(), data:{ [key]: getRowState(key) }};
  const payload = encodeURIComponent(JSON.stringify(payloadObj));
  const url = `${REMOTE_ENDPOINT}?action=set&data=${payload}&token=${encodeURIComponent(SESSION_TOKEN)}`;
  const res = await jsonp(url);
  if(res && res.error){ logout(); return; }
  await pullRemote();
}
function startRemoteSync(forcePull=false){
  if(remoteStartTimer){ clearTimeout(remoteStartTimer); remoteStartTimer=null; }
  if(remotePullTimer){ clearInterval(remotePullTimer); remotePullTimer=null; }
  const start = ()=>{ if(forcePull) pullRemote(); remotePullTimer = setInterval(()=>pullRemote(), REMOTE_POLL_MS + Math.floor(Math.random()*1000)); };
  const jitter = Math.floor(Math.random()*REMOTE_POLL_MS);
  remoteStartTimer = setTimeout(start, jitter);
}

function startConfigWatch(){
  if(configWatchTimer) clearInterval(configWatchTimer);
  configWatchTimer = setInterval(async ()=>{
    if(!SESSION_TOKEN) return;
    try{
      const cfg = await jsonp(`${REMOTE_ENDPOINT}?action=getConfig&token=${encodeURIComponent(SESSION_TOKEN)}&nocache=1`);
      if(cfg && !cfg.error && typeof cfg.updated === 'number' && cfg.updated > CONFIG_UPDATED){
        const prev = getState();
        GROUPS = normalizeConfigClient(cfg);
        CONFIG_UPDATED = cfg.updated;
        render();
        applyState(prev);
      }
    }catch(e){}
  }, CONFIG_POLL_MS);
}
function scheduleRenew(expMs){
  if(tokenRenewTimer){ clearTimeout(tokenRenewTimer); tokenRenewTimer=null; }
  const delay = Math.max(10000, Math.floor(expMs * 0.8));
  tokenRenewTimer = setTimeout(renewToken, delay);
}
async function renewToken(){
  if(!SESSION_TOKEN) return;
  const res = await jsonp(`${REMOTE_ENDPOINT}?action=renew&token=${encodeURIComponent(SESSION_TOKEN)}`);
  if(res && res.ok){
    const next = Number(res.exp) || TOKEN_DEFAULT_TTL;
    scheduleRenew(next);
  }else{
    logout();
  }
}

/* ===== Admin（管理API呼び出し） ===== */
function selectedOfficeId(){
  return isSuper() ? adminOfficeSel.value : CURRENT_OFFICE_ID;
}
async function adminListOffices(){
  return await jsonp(`${REMOTE_ENDPOINT}?action=listOffices&token=${encodeURIComponent(SESSION_TOKEN)}`);
}
async function adminGetFor(office){
  return await jsonp(`${REMOTE_ENDPOINT}?action=getFor&office=${encodeURIComponent(office)}&token=${encodeURIComponent(SESSION_TOKEN)}&nocache=1`);
}
async function adminGetConfigFor(office){
  return await jsonp(`${REMOTE_ENDPOINT}?action=getConfigFor&office=${encodeURIComponent(office)}&token=${encodeURIComponent(SESSION_TOKEN)}&nocache=1`);
}
async function adminSetConfigFor(office, cfgObj){
  const payload = encodeURIComponent(JSON.stringify(cfgObj));
  return await jsonp(`${REMOTE_ENDPOINT}?action=setConfigFor&office=${encodeURIComponent(office)}&data=${payload}&token=${encodeURIComponent(SESSION_TOKEN)}`);
}
async function adminSetForChunked(office, dataObjFull){
  const entries = Object.entries(dataObjFull || {});
  if(entries.length===0){
    return await jsonp(`${REMOTE_ENDPOINT}?action=setFor&office=${encodeURIComponent(office)}&data=${encodeURIComponent(JSON.stringify({updated:Date.now(), data:{}, full:true}))}&token=${encodeURIComponent(SESSION_TOKEN)}`);
  }
  const chunkSize = 100;
  let first = true, ok=true;
  for(let i=0;i<entries.length;i+=chunkSize){
    const chunk = Object.fromEntries(entries.slice(i, i+chunkSize));
    const obj = {updated:Date.now(), data:chunk, full:first};
    const res = await jsonp(`${REMOTE_ENDPOINT}?action=setFor&office=${encodeURIComponent(office)}&data=${encodeURIComponent(JSON.stringify(obj))}&token=${encodeURIComponent(SESSION_TOKEN)}`);
    if(!(res && res.ok)) ok=false;
    first = false;
  }
  return ok?{ok:true}:{error:'chunk_failed'};
}
async function adminRenameOffice(office, name){
  return await jsonp(`${REMOTE_ENDPOINT}?action=renameOffice&office=${encodeURIComponent(office)}&name=${encodeURIComponent(name)}&token=${encodeURIComponent(SESSION_TOKEN)}`);
}
async function adminAddOffice(id, name, pw, apw){
  return await jsonp(`${REMOTE_ENDPOINT}?action=addOffice&id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}&password=${encodeURIComponent(pw)}&adminPassword=${encodeURIComponent(apw)}&token=${encodeURIComponent(SESSION_TOKEN)}`);
}
async function adminDeleteOffice(office){
  return await jsonp(`${REMOTE_ENDPOINT}?action=deleteOffice&id=${encodeURIComponent(office)}&token=${encodeURIComponent(SESSION_TOKEN)}`);
}
async function adminSetOfficePassword(office, pw, apw){
  const q = [`id=${encodeURIComponent(office)}`];
  if(pw)  q.push(`password=${encodeURIComponent(pw)}`);
  if(apw) q.push(`adminPassword=${encodeURIComponent(apw)}`);
  return await jsonp(`${REMOTE_ENDPOINT}?action=setOfficePassword&${q.join('&')}&token=${encodeURIComponent(SESSION_TOKEN)}`);
}

/* ===== CSVユーティリティ ===== */
function toCsvRow(arr){
  return arr.map(v=>{
    const s = (v==null)?'':String(v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }).join(',');
}
function makeNormalizedCSV(cfg, data){
  const rows = [];
  rows.push(toCsvRow(['group_index','group_title','member_order','id','name','ext','status','time','note']));
  (cfg.groups||[]).forEach((g,gi)=>{
    (g.members||[]).forEach((m,mi)=>{
      const id = m.id || '';
      const rec = (data && data[id]) || {};
      rows.push(toCsvRow([
        gi+1,
        g.title||'',
        mi+1,
        id,
        m.name||'',
        m.ext||'',
        rec.status||'在席',
        rec.time||'',
        rec.note||''
      ]));
    });
  });
  return rows.join('\n');
}
function parseCSV(text){
  const out=[]; let i=0, s=text;
  let row=[]; let field=''; let inq=false;
  function pushField(){ row.push(field); field=''; }
  function pushRow(){ out.push(row); row=[]; }
  while(i<s.length){
    const c=s[i++];
    if(inq){
      if(c==='"' && s[i]==='"'){ field+='"'; i++; }
      else if(c==='"'){ inq=false; }
      else field+=c;
    }else{
      if(c===','){ pushField(); }
      else if(c==='"'){ inq=true; }
      else if(c==='\n'){ pushField(); pushRow(); }
      else if(c==='\r'){ /* skip */ }
      else field+=c;
    }
  }
  if(field!=='') pushField();
  if(row.length) pushRow();
  return out;
}

/* ===== Admin/UI ===== */
function toast(msg, ok=true){
  toastEl.style.background = ok ? '#334155' : '#c53030';
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1600);
}
function showAdmin(yes){ adminModal.classList.toggle('show', !!yes); }

function applyRoleToAdminPanel(){
  // 拠点選択行の表示：スーパ管理者のみ
  adminOfficeRow.style.display = isSuper() ? '' : 'none';
  // 「拠点追加/削除」ボックス：スーパ管理者のみ
  document.querySelectorAll('.admin-box[data-super-only="1"]').forEach(el=>{
    el.style.display = isSuper() ? '' : 'none';
  });
}

async function populateAdminOffices(selected){
  if(isSuper()){
    const res = await adminListOffices();
    if(!(res && res.offices)) { toast('拠点一覧の取得に失敗', false); return; }
    adminOfficeSel.innerHTML = res.offices.map(o=>`<option value="${o.id}">${o.name}（${o.id}）</option>`).join('');
    if(selected){ adminOfficeSel.value = selected; }
  }else{
    // 拠点管理者：自拠点のみ
    adminOfficeSel.innerHTML = `<option value="${CURRENT_OFFICE_ID}">${CURRENT_OFFICE_NAME}（${CURRENT_OFFICE_ID}）</option>`;
  }
}

/* Export */
btnExport.addEventListener('click', async ()=>{
  const office = selectedOfficeId();
  const cfg = await adminGetConfigFor(office);
  const dat = await adminGetFor(office);
  if(!(cfg && cfg.groups) || !(dat && typeof dat.data==='object')){ toast('エクスポート失敗', false); return; }
  const csv = makeNormalizedCSV(cfg, dat.data);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `presence_${office}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
});

/* Import */
btnImport.addEventListener('click', async ()=>{
  const office = selectedOfficeId();
  const file = csvFile.files && csvFile.files[0];
  if(!file){ toast('CSVを選択してください', false); return; }
  const text = await file.text();
  const rows = parseCSV(text);
  if(!rows.length){ toast('CSVが空です', false); return; }
  const hdr = rows[0].map(s=>s.trim());
  const must = ['group_index','group_title','member_order','id','name','ext','status','time','note'];
  if(must.some((h,i)=> hdr[i] !== h)){ toast('CSVヘッダが不正です', false); return; }

  const recs = rows.slice(1).filter(r=>r.some(x=> (x||'').trim()!=='' )).map(r=>{
    const [gi,gt,mi,id,name,ext,status,time,note] = r;
    return {
      gi: Number(gi)||0,
      gt: (gt||''),
      mi: Number(mi)||0,
      id: (id||''),
      name: (name||''),
      ext: (ext||''),
      status: (status||'在席'),
      time: (time||''),
      note: (note||'')
    };
  });

  const groupsMap = new Map();
  for(const r of recs){
    if(!r.gi || !r.mi || !r.name){ continue; }
    if(!groupsMap.has(r.gi)) groupsMap.set(r.gi, { title:r.gt||'', members:[] });
    const g = groupsMap.get(r.gi);
    g.title = r.gt||'';
    g.members.push({ _mi:r.mi, name:r.name, ext:r.ext||'', id: r.id||undefined });
  }
  const groups = Array.from(groupsMap.entries()).sort((a,b)=>a[0]-b[0]).map(([gi, g])=>{
    g.members.sort((a,b)=> (a._mi||0)-(b._mi||0));
    g.members.forEach(m=> delete m._mi);
    return g;
  });
  const cfgToSet = { version:2, updated: Date.now(), groups };

  const r1 = await adminSetConfigFor(office, cfgToSet);
  if(!(r1 && r1.ok)){ toast('名簿の設定に失敗', false); return; }

  const newCfg = await adminGetConfigFor(office);
  if(!(newCfg && newCfg.groups)){ toast('名簿再取得に失敗', false); return; }

  const keyOf = (gi, gt, mi, name, ext)=> [String(gi), String(gt||''), String(mi), String(name||''), String(ext||'')].join('|');
  const idIndex = new Map();
  (newCfg.groups||[]).forEach((g, gi0)=>{
    (g.members||[]).forEach((m, mi0)=>{
      idIndex.set(keyOf(gi0+1, g.title||'', mi0+1, m.name||'', m.ext||''), m.id);
    });
  });

  const dataObj = {};
  for(const r of recs){
    const id = r.id || idIndex.get(keyOf(r.gi, r.gt, r.mi, r.name, r.ext||'')) || null;
    if(!id) continue;
    dataObj[id] = { ext: r.ext||'', status: STATUSES.includes(r.status)? r.status : '在席', time: r.time||'', note: r.note||'' };
  }

  const r2 = await adminSetForChunked(office, dataObj);
  if(!(r2 && r2.ok)){ toast('在席データ更新に失敗', false); return; }

  toast('インポート完了', true);
});

/* Rename Office */
btnRenameOffice.addEventListener('click', async ()=>{
  const office = selectedOfficeId();
  const name = (renameOfficeName.value||'').trim();
  if(!name){ toast('新しい拠点名を入力', false); return; }
  const r = await adminRenameOffice(office, name);
  if(r && r.ok){ toast('拠点名を変更しました'); await populateAdminOffices(office); }
  else toast('変更に失敗', false);
});

/* Add Office（スーパのみ） */
btnAddOffice.addEventListener('click', async ()=>{
  if(!isSuper()){ toast('権限がありません', false); return; }
  const id = (addOfficeId.value||'').trim();
  const name = (addOfficeName.value||'').trim();
  const pw = (addOfficePw.value||'').trim();
  const apw = (addOfficeAdminPw.value||'').trim();
  if(!/^[A-Za-z0-9_-]+$/.test(id)){ toast('IDは半角英数_-のみ', false); return; }
  if(!name || !pw || !apw){ toast('拠点名/パスワードを入力', false); return; }
  const r = await adminAddOffice(id, name, pw, apw);
  if(r && r.ok){ toast('拠点を追加しました'); await populateAdminOffices(id); }
  else toast('追加に失敗', false);
});

/* Delete Office（スーパのみ） */
btnDeleteOffice.addEventListener('click', async ()=>{
  if(!isSuper()){ toast('権限がありません', false); return; }
  const office = adminOfficeSel.value;
  if(!confirm(`拠点「${office}」を削除します。復元できません。よろしいですか？`)) return;
  const r = await adminDeleteOffice(office);
  if(r && r.ok){ toast('拠点を削除しました'); await populateAdminOffices(); }
  else toast('削除に失敗', false);
});

/* Set Password */
btnSetPw.addEventListener('click', async ()=>{
  const office = selectedOfficeId();
  const pw  = (setPw.value||'').trim();
  const apw = (setAdminPw.value||'').trim();
  if(!pw && !apw){ toast('更新する項目を入力', false); return; }
  const r = await adminSetOfficePassword(office, pw, apw);
  if(r && r.ok){ toast('パスワードを更新しました'); setPw.value=''; setAdminPw.value=''; }
  else toast('更新に失敗', false);
});

/* 管理モーダル開閉 + ログオフ */
adminBtn.addEventListener('click', async ()=>{
  applyRoleToAdminPanel();
  await populateAdminOffices(CURRENT_OFFICE_ID);
  showAdmin(true);
});
adminClose.addEventListener('click', ()=> showAdmin(false));
refreshOfficesBtn.addEventListener('click', ()=> populateAdminOffices(adminOfficeSel.value));
logoutBtn.addEventListener('click', ()=> logout());

/* ===== 起動 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  window.__doLogin = async () => {
    const pw = pwInput.value;
    const office = officeSel.value;
    if(!pw || !pw.trim()){ loginMsg.textContent="パスワードを入力してください"; return; }
    loginMsg.textContent = "認証中…";
    const res = await jsonp(`${REMOTE_ENDPOINT}?action=login&office=${encodeURIComponent(office)}&password=${encodeURIComponent(pw)}`);
    if(res === null){ loginMsg.textContent = "通信エラー（公開設定/URLを確認）"; return; }
    if(res && res.error === 'unauthorized'){ loginMsg.textContent = "拠点またはパスワードが違います"; return; }
    if(!(res && res.token)){ loginMsg.textContent = "サーバ応答が不正です"; return; }

    SESSION_TOKEN = res.token; sessionStorage.setItem(SESSION_KEY, SESSION_TOKEN);
    CURRENT_OFFICE_NAME = res.officeName || "";
    CURRENT_OFFICE_ID = res.office || "";
    CURRENT_ROLE = res.role || "user";
    titleBtn.textContent = (CURRENT_OFFICE_NAME? `${CURRENT_OFFICE_NAME}　在席確認表` : '在席確認表');
    loginEl.style.display='none'; loginMsg.textContent="";

    ensureAuthUI();

    const cfgP  = tryLoadGroupsFromServer(true).catch(()=>{});
    const dataP = fastFetchDataOnce().catch(()=>null);

    await cfgP; render(); loadLocal();
    const data = await dataP; if(data && data.data) applyState(data.data);

    scheduleRenew(Number(res.exp)||TOKEN_DEFAULT_TTL);
    startRemoteSync(true);
    startConfigWatch();
  };

  document.getElementById('btnLogin').addEventListener('click', window.__doLogin);
  pwInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') window.__doLogin(); });

  const existing = sessionStorage.getItem(SESSION_KEY);
  if(existing){
    SESSION_TOKEN = existing; loginEl.style.display='none';
    (async ()=>{
      const ok = await jsonp(`${REMOTE_ENDPOINT}?action=renew&token=${encodeURIComponent(SESSION_TOKEN)}`);
      if(ok && ok.ok){
        scheduleRenew(Number(ok.exp)||TOKEN_DEFAULT_TTL);
        const cfgP  = tryLoadGroupsFromServer(true).catch(()=>{});
        const dataP = fastFetchDataOnce().catch(()=>null);
        await cfgP; render(); loadLocal();
        const data = await dataP; if(data && data.data) applyState(data.data);
        startRemoteSync(true);
        startConfigWatch();
        ensureAuthUI();
      }else{
        logout();
      }
    })();
  }else{
    loginEl.style.display='flex';
    ensureAuthUI();
  }
});

/* エラー表示 */
window.addEventListener('error', e=>{
  toastEl.style.background='#c53030';
  toastEl.textContent='エラー: '+e.message;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1500);
});
</script>

<datalist id="noteOptions">
  <option value=""></option>
  <option value="直出"></option>
  <option value="直帰"></option>
  <option value="直出/直帰"></option>
</datalist>
</body>
</html>
